<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Test UI</title>
    <script src="objectDefaultFiles/pep.min.js"></script>
    <script src="objectDefaultFiles/object.js"></script>
    <style>
        body {
            overflow: visible;
        }
        #container {
            width: 538px;
            height: 290px;
            border: 5px solid cyan;
            border-radius: 10px;
            padding: 10px;
            position: relative;
            display: table-cell;
            vertical-align: middle;
            text-align: center;
        }
        
        #imageContainer {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
            width: 558px;
            height: 310px;
        }

        .hidden {
            display: none;
        }

        .visible {
            display: inline-block;
        }

        .spinner {
            width: 70px;
            text-align: center;
        }

        .spinner > div {
            width: 18px;
            height: 18px;
            background-color: cyan;

            border-radius: 100%;
            display: inline-block;
            -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
            animation: sk-bouncedelay 1.4s infinite ease-in-out both;
        }

        .spinner .bounce1 {
            -webkit-animation-delay: -0.32s;
            animation-delay: -0.32s;
        }

        .spinner .bounce2 {
            -webkit-animation-delay: -0.16s;
            animation-delay: -0.16s;
        }

        @-webkit-keyframes sk-bouncedelay {
            0%, 80%, 100% { -webkit-transform: scale(0) }
            40% { -webkit-transform: scale(1.0) }
        }

        @keyframes sk-bouncedelay {
            0%, 80%, 100% {
                -webkit-transform: scale(0);
                transform: scale(0);
            } 40% {
                  -webkit-transform: scale(1.0);
                  transform: scale(1.0);
              }
        }
        
        .buttonOutline {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 5px solid white;
        }
        
        #captureButton {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background-color: white;
            margin-top: 13px;
            -webkit-transform: scale(1);
        }
        
    </style>
</head>
<body>
    
    <div id="container" touch-action="none">
        <div>
            <div id="imageContainer" class="hidden"></div>
            <!--<video id="recordedVideo" class="hidden" width="558" height="310" playsinline webkit-playsinline></video>-->
            
            <div id="captureButtonOutline" class="buttonOutline visible">
                <div id="captureButton" class="visible">
                </div>
            </div>
            
            <!--<div class="recordingIndicator hidden">-->
                <!--<div class="recordingDot"></div>-->
                <!--<div class="recordingText">REC</div>-->
            <!--</div>-->

            <div class="spinner visible">
                <div class="bounce1"></div>
                <div class="bounce2"></div>
                <div class="bounce3"></div>
            </div>

            <!--<div id="playButtonOutline" class="buttonOutline hidden">-->
                <!--<div id="playButton" class="visible">-->
                <!--</div>-->
            <!--</div>-->
            
        </div>
    </div>

    <script>
        
        // TODO: programmatically set width and height based on phone screen size
        var isRecording = false;
        var secondsRecorded = 0;
        var recordingInterval = null;
        var recordButton = document.getElementById('recordButton');
        
        var isPlaying = false;
        var playButton = document.getElementById('playButton');
        var playButtonOutline = document.querySelector('#playButtonOutline');

        var container = document.getElementById('container');
        var recordedVideo = document.getElementById('recordedVideo');
        var spinner = document.querySelector('.spinner');
        var source = document.createElement('source');
        
        var realityInterface = new RealityInterface();

        var recordButtonAppearanceDelay = null;
        
        function initVideo() {
            console.log('video created');
            source.setAttribute('src', '');
            recordedVideo.appendChild(source);

            recordedVideo.addEventListener('progress', function(e) {
                console.log('progress', e);

                // hide record button
                document.querySelector('#recordButtonOutline').classList.remove('visible');
                document.querySelector('#recordButtonOutline').classList.add('hidden');

                // show video
                recordedVideo.classList.remove('hidden');
                recordedVideo.classList.add('visible');

                clearInterval(interval);
                // window.requestAnimationFrame(loop);
            });

            recordedVideo.addEventListener('canplaythrough', function(e) {
                console.log('canplaythrough', e);
                // recordedVideo.play();

                // hide loading spinner
                spinner.classList.remove('visible');
                spinner.classList.add('hidden');

                // show play/stop button
                document.querySelector('#playButtonOutline').classList.remove('hidden');
                document.querySelector('#playButtonOutline').classList.add('visible');

                container.removeEventListener('pointerup', toggleRecording);
                container.addEventListener('pointerup', togglePlaying);
            });
            
            recordedVideo.addEventListener('ended', function(e) {
                console.log('video ended');
                realityInterface.write('next', 1.0);
            });
            
            // decide whether to show record button or (play button + video)
            recordButtonAppearanceDelay = setTimeout(showRecordButton, 3000);
        }
        initVideo();
        
        function showRecordButton() {
            if (source.getAttribute('src') === '') {
                // hide loading spinner
                spinner.classList.remove('visible');
                spinner.classList.add('hidden');

                // show record button
                document.querySelector('#recordButtonOutline').classList.remove('hidden');
                document.querySelector('#recordButtonOutline').classList.add('visible');
                
                function startRecordingPressed() {
                    if (!isRecording) {
                        toggleRecording();
                        container.removeEventListener('pointerup', startRecordingPressed);
                        recordButton.addEventListener('pointerup', toggleRecording);
                    }
                }

                container.addEventListener('pointerup', startRecordingPressed);
            }
        }

        // recordButton.addEventListener('pointerup', toggleRecording);
        
        function toggleRecording(e) {
            isRecording = !isRecording;

            if (isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        function startRecording() {
            recordButton.classList.add('currentlyRecording');
            
            setTimeout(function() {

                realityInterface.setStickyFullScreenOn();
                realityInterface.startVideoRecording();

                document.querySelector('.recordingIndicator').classList.remove('hidden');
                document.querySelector('.recordingIndicator').classList.add('visible');
                
                secondsRecorded = 0;
                document.querySelector('.recordingText').innerHTML = 'REC   ' + formatSecondsAsTime(secondsRecorded);
                
                recordingInterval = setInterval(function() {
                    secondsRecorded += 1;
                    document.querySelector('.recordingText').innerHTML = 'REC   ' + formatSecondsAsTime(secondsRecorded);
                }, 1000);
                
            }, 250);

        }
        
        function stopRecording() {
            recordButton.classList.remove('currentlyRecording');
            
            setTimeout(function() {
                
                realityInterface.setFullScreenOff();
                
                realityInterface.stopVideoRecording(function(videoFilePath) {
                    console.log('video was saved at path: ' + videoFilePath);
                    realityInterface.writePublicData("storage", "data",  videoFilePath);
                    loadVideoPath(videoFilePath);
                });

                // hide indicator and timer in corner
                document.querySelector('.recordingIndicator').classList.remove('visible');
                document.querySelector('.recordingIndicator').classList.add('hidden');
                
                document.querySelector('#recordButtonOutline').classList.add('hiddenRecordingButton');
                
                setTimeout(function() {
                    // hide stop button
                    document.querySelector('#recordButtonOutline').classList.remove('visible');
                    document.querySelector('#recordButtonOutline').classList.add('hidden');

                    // show loading indicator
                    document.querySelector('.spinner').classList.remove('hidden');
                    document.querySelector('.spinner').classList.add('visible');
                }, 500);
                
            }, 0);
        }
        
        // playButtonOutline.addEventListener('pointerup', togglePlaying);
        
        function togglePlaying(e) {
            isPlaying = !isPlaying;

            if (isPlaying) {
                startPlaying();
            } else {
                stopPlaying();
            }
        }
        
        function startPlaying() {
            playButton.classList.add('currentlyPlaying');
            playButtonOutline.classList.add('currentlyPlaying');
            recordedVideo.play();
        }
        
        function stopPlaying() {
            playButton.classList.remove('currentlyPlaying');
            playButtonOutline.classList.remove('currentlyPlaying');
            recordedVideo.pause();
        }
        
        function formatSecondsAsTime(seconds) {
            var hours = Math.floor(seconds / 3600);
            seconds -= hours * 3600;
            var minutes = Math.floor(seconds / 60);
            seconds -= minutes * 60;
            return hours.pad() + ':' + minutes.pad() + ':' + seconds.pad();
        }

        Number.prototype.pad = function(size) {
            var s = String(this);
            while (s.length < (size || 2)) {s = "0" + s;}
            return s;
        };

        realityInterface.addReadPublicDataListener('storage', 'data', function (e) {
            if (typeof e !== 'string' || e.length === 0) {
                clearTimeout(recordButtonAppearanceDelay);
                showRecordButton();
                console.log('cant load non-string data:', e);
                return;
            }
            if (e === source.getAttribute('src')) {
                console.log('dont reload the same video');
                return;
            }

            loadVideoPath(e);
        });
        
        function loadVideoPath(videoFilePath) {
            attemptToLoadVideo(videoFilePath, 10);
        }

        function attemptToLoadVideo(videoUrl, attemptsLeft) {
            if (attemptsLeft <= 0) {
                console.log('no more attempts.. failed to load video');
                // TODO: show error UI
                return;
            }
            console.log('load video from url: ' + videoUrl);

            // recordedVideo.pause();
            source.addEventListener('error', function(e) {
                console.log('failed to load');
                setTimeout(function() {
                    attemptToLoadVideo(videoUrl, attemptsLeft-1);
                    console.log('trying again (' + (attemptsLeft-1) + ' attempts left)');
                }, 3000);
            });
            source.setAttribute('src', videoUrl);
            clearTimeout(recordButtonAppearanceDelay);
            recordedVideo.load();
        }
        
        // networking to read and write public data

        // var videoUrl = '';
        // var realityInterface = new RealityInterface();
        // realityInterface.setMoveDelay(300);

        // var recordedVideo = document.getElementById('recordedVideo');
        // var spinner = document.querySelector('.spinner');
        // var source = document.createElement('source');
        //
        // console.log('video created');
        // source.setAttribute('src', videoUrl);
        // recordedVideo.appendChild(source);
        // recordedVideo.addEventListener('pointerup', onPointerUp);
        // recordedVideo.addEventListener('progress', function(e) {
        //     console.log('progress', e);
        //     recordedVideo.classList.remove('hidden');
        //     recordedVideo.classList.add('visible');
        //     spinner.classList.remove('visible');
        //     spinner.classList.add('hidden');
        //     clearInterval(interval);
        //     window.requestAnimationFrame(loop);
        // });

        // var attemptsLeft = 10;
        // realityInterface.addReadPublicDataListener('storage', 'data', function (e) {
        //     if (typeof e !== 'string' || e.length === 0) {
        //         console.log('can\'t load non-string data:', e);
        //         return;
        //     }
        //     if (e === videoUrl) {
        //         console.log('don\'t reload the same video');
        //         return;
        //     }
        //     videoUrl = e;
        //
        //     loadVideo(10);
        // });

        realityInterface.addReadListener('play', function(e) {
            if (e.value > 0.5) {
                if (recordedVideo.paused) {
                    recordedVideo.play();
                }
            } else {
                if (!recordedVideo.paused) {
                    recordedVideo.pause();
                }
            }
        });

        // var lastProgess = 0;
        // function loop() {
        //     if (!recordedVideo.paused) {
        //         var thisProgress = recordedVideo.currentTime / recordedVideo.duration;
        //         if (thisProgress !== lastProgess) {
        //             lastProgess = thisProgress;
        //             realityInterface.write('progress', thisProgress);
        //             console.log('new progress = ' + thisProgress);
        //         }
        //     }
        //     window.requestAnimationFrame(loop);
        // }

        realityInterface.addReadListener('progress', function(e) {

            if (e.value === lastProgess) return;

            if (recordedVideo.paused) {
                recordedVideo.currentTime = e.value * recordedVideo.duration;
            }
        });

        // function loadVideo(attemptsLeft) {
        //     attemptsLeft--;
        //     if (attemptsLeft <= 0) {
        //         console.log('no more attempts.. failed to load video');
        //         // TODO: show error UI
        //         return;
        //     }
        //     console.log('load video from url: ' + videoUrl);
        //
        //     // recordedVideo.pause();
        //     source.addEventListener('error', function(e) {
        //         console.log('failed to load');
        //         setTimeout(function() {
        //             loadVideo(attemptsLeft-1);
        //             console.log('trying again (' + attemptsLeft-1 + ' attempts left)');
        //         }, 3000);
        //     });
        //     source.setAttribute('src', videoUrl);
        //     recordedVideo.load();
        // }

        var numRepetitions = 10;
        var interval = setInterval(function() {
            numRepetitions--;
            if (numRepetitions <= 0) {
                clearInterval(interval);
                return;
            }
            realityInterface.reloadPublicData();
        }, 3000);
        
    </script>

</body>
</html>
