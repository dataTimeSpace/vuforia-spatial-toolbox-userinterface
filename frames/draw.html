<!doctype html>
<html>
<head>
    <script src="objectDefaultFiles/object.js"></script>
    <script src="objectDefaultFiles/pep.min.js"></script>
    <title>Sketch Pad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0" />
    <style type="text/css">
        body {
            margin:0px;
            width:600px;
            height:450px;
            overflow:hidden;
            font-family:Arial;
            /* prevent text selection on ui */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* prevent scrolling in windows phone */
            -ms-touch-action: none;
            /* prevent selection highlight */
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            overflow: hidden;
        }
        
        .navbtn {
            z-index: 3;
            cursor: pointer;
            float:left;
            height: 90px;
            width: 90px;
            font-weight: bold;
            line-height: 50px;
            font-size: 22px;
            color: #eee;
            border: solid 1px #111;
            border-radius: 4px;
            background-color: #404040;
        }

        #content{
            position: absolute;
            left: 0px;
            right: 0px;
            overflow:hidden;
            background-color:rgba(255,255,255,0.15);
        }
        #canvas{
            cursor:crosshair ;
            background-color:rgba(255,255,255,0);
        }
        .palette-case {
            width:600px;
            margin:auto;
            text-align:center;
        }
        .palette-box {
            float:left;
            padding:2px 6px 2px 6px;
        }
        .palette {
            border:0px;
            height: 90px;
            width:90px;
        }
        .red{
            background-color:rgb(242,22,121);
        }
        .blue{
            background-color:rgb(45,255,255);
        }
        .green{
            background-color:rgb(41,253,47);
        }
        .white{
            background-color:#fff;
        }
    </style>
  
</head>
<body style="width: 600px; height:500px;">
    <div id="content" style="height: 600px; width: 600px"><canvas id="canvas" style="height: 600px; width: 600px" width="600px" height="500px"></canvas></div>
        <div class="palette-case" style="top: 510px; position: fixed">
            <a id="new" class="navbtn" onclick="clearCanvas()">New</a>
            <div class="palette-box">
                <div class="palette white" onclick="selectColor(this)"></div>
            </div>
            <div class="palette-box">
                <div class="palette red" onclick="selectColor(this)"></div>
            </div>
            <div class="palette-box">
                <div class="palette blue" onclick="selectColor(this)"></div>
            </div>
            <div class="palette-box">
                <div class="palette green" onclick="selectColor(this)"></div>
            </div>
            <div style="clear:both"></div>
        </div>


    <script type="text/javascript">

        var realityInterface = new RealityInterface();
        realityInterface.setMoveDelay(500);


        var imageContent = [];
        var color = "rgb(41,253,47)";

        var ctx = document.getElementById("canvas").getContext("2d");
        ctx.strokeStyle = color;
        ctx.lineWidth = 10;

        document.addEventListener( "DOMContentLoaded", function(){
            
            setTimeout(function(){
                newCanvas();
            }, 100);

        }, false );
        
        function newCanvas(){
            drawPointerEvents();

            document.querySelector('#new').addEventListener('pointerdown', clearCanvas);

            document.querySelectorAll('.palette').forEach(function(palette){
                palette.addEventListener('pointerdown', function() {
                    selectColor(palette);
                });
            });

        }
        function clearCanvas(){
            ctx = document.getElementById("canvas").getContext("2d");
            ctx.clearRect(0, 0, 600, 600);
            imageContent = [];
            realityInterface.writePublicData("storage", "data",  imageContent);
        }

        function selectColor(el){
            for(var i=0;i<document.getElementsByClassName("palette").length;i++){
                document.getElementsByClassName("palette")[i].style.borderColor = "#777";
                document.getElementsByClassName("palette")[i].style.borderStyle = "solid";
            }
            el.style.borderColor = "rgba(255,255,255,0)";
            el.style.borderStyle = "dashed";
            color = window.getComputedStyle(el).backgroundColor;
            ctx.beginPath();
            ctx.strokeStyle = color;
        }
        
        // prototype to	start drawing on mouse using canvas moveTo and lineTo
        var drawPointerEvents = function() {
            var clicked = 0;
            var start = function(e) {
                if(!imageContent) imageContent = [];
                clicked = 1;
                var x = e.clientX;
                var y = e.clientY-44;
                moveTo(x,y,color, ctx);
                imageContent.push({c : color, x : x, y : y});
            };
            var move = function(e) {
          
                if(clicked){
                    if(!imageContent) imageContent = [];
                    x = e.clientX;
                    y = e.clientY-44;
                    lineTo(x,y, ctx);
                    imageContent.push({x : x, y : y});
                }
           
            };
            var stop = function(e) {
                clicked = 0;
                realityInterface.writePublicData("storage", "data",  imageContent);
            };
            document.getElementById("canvas").addEventListener("pointerdown", start, false);
            document.getElementById("canvas").addEventListener("pointermove", move, false);
            document.addEventListener("pointerup", stop, false);
        };

        function moveTo(x,y,c, ctx){
                ctx.strokeStyle = c;
            ctx.beginPath();
            ctx.moveTo(x,y);
        }

        function lineTo(x,y, ctx){
            ctx.lineTo(x,y);
            ctx.stroke();
        }


        realityInterface.addReadPublicDataListener('storage', "data", function (e) {
            var ctx = document.getElementById("canvas").getContext("2d");
            ctx.lineWidth = 10;

            if(Array.isArray(e)) {
                imageContent = e;
            }
            
            if (e.length === 0) {
                clearCanvas();
            }
            
            for(var i =0; i<e.length; i++){
                var point = e[i];
                if("c" in point){
                    moveTo(point.x, point.y, point.c, ctx);
                } else {
                    lineTo(point.x, point.y, ctx);
                }
            }
            // document.querySelector('#show').style.visibility = "visible";
        });
        
    </script>
</body>
</html>
