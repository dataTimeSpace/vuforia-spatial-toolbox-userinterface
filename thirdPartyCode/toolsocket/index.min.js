class t{constructor(){this.eCb={},this.dec=new TextDecoder,this.enc=new TextEncoder}on(t,...e){this.eCb[t]||(this.eCb[t]=[]),this.eCb[t].push(...e)}emitInt(t,...e){this.eCb[t]&&this.eCb[t].forEach((t=>t(...e)))}removeAllListeners(){for(let t in this.eCb)delete this.eCb[t]}intToByte=t=>[t>>24&255,t>>16&255,t>>8&255,255&t];byteToInt=t=>t[t.length-1]|t[t.length-2]<<8|t[t.length-3]<<16|t[t.length-4]<<24;validate=(t,e,i)=>{if("object"!=typeof t)return!1;let s=(t,e,i)=>"string"==typeof t[i]&&(!(Number.isInteger(e[i].minLength)&&t[i].length<e[i].minLength)&&(!(Number.isInteger(e[i].maxLength)&&t[i].length>e[i].maxLength)&&(!(e[i].pattern&&!t[i].match(e[i].pattern))&&!(e[i].enum&&!e[i].enum.includes(t[i]))))),n=(t,e,i)=>!!Number.isInteger(t[i])&&(!(Number.isInteger(e[i].minimum)&&t[i]<e[i].minimum)&&!(Number.isInteger(e[i].maximum)&&t[i]>e[i].maximum)),o=(t,e,i)=>("res"!==t.m||null!==t[i])&&null===t[i],r=(t,e,i)=>"boolean"==typeof t[i],h=(t,e,i)=>"number"==typeof t[i],a=(t,e,i)=>!t[i],c=(t,e,i,s)=>!!Array.isArray(t[i])&&(!(Number.isInteger(e[i].minLength)&&s<e[i].minLength)&&!(Number.isInteger(e[i].maxLength)&&s>e[i].maxLength)),l=(t,e,i,s)=>{if("object"==typeof t[i])return!(Number.isInteger(e[i].minLength)&&s<e[i].minLength)&&!(Number.isInteger(e[i].maxLength)&&s>e[i].maxLength)},b=(t,e,i)=>e.hasOwnProperty(i),d=i.items.properties,p=!0;for(let i in t)if(b(0,d,i)){let b=!1;d[i].type.includes("string")&&s(t,d,i)&&(b=!0),d[i].type.includes("integer")&&n(t,d,i)&&(b=!0),d[i].type.includes("null")&&o(t,0,i)&&(b=!0),d[i].type.includes("boolean")&&r(t,0,i)&&(b=!0),d[i].type.includes("number")&&h(t,0,i)&&(b=!0),d[i].type.includes("array")&&c(t,d,i,e)&&(b=!0),d[i].type.includes("object")&&l(t,d,i,e)&&(b=!0),d[i].type.includes("undefined")&&a(t,0,i)&&(b=!0),b||(p=!1)}else p=!1;return((t,e)=>{for(let i in e)if(!t.hasOwnProperty(e[i]))return!1;return!0})(t,i.items.required)||(p=!1),p};parseUrl=(t,e)=>{let i=t.split("://"),s=null,n=null,o=null;i&&i[1]&&(t=i[1],s=i[0]);let r=t.split("/");if(s){n=r[0],r.shift();let t=n.split(":");n=t[0],t[1]&&(o=parseInt(Number(t[1])))}let h={},a="",c=[];r[r.length-1]&&(c=r[r.length-1].split("?"));let l=null;c&&c[0]&&(l=c[0].split("."),c[1]&&(r[r.length-1]=c[0]));try{e.items.properties.type||(e.items.properties.type={type:"string",minLength:1,maxLength:5,enum:["jpg","jpeg","gif","zip","glb","html","map","htm","xml","dat","png","js","json","obj","fbx","svg","mp4","pdf","csv","css","woff","otf","webm","webp","ttf"]}),e.items.properties.protocol||(e.items.properties.protocol={type:"string",minLength:1,maxLength:20,enum:["spatialtoolbox","ws","wss","http","https"]}),e.items.properties.query||(e.items.properties.query={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9~!@$%^&*()-_=+{}|;:,./?]*$"}),e.items.properties.route||(e.items.properties.route={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9/~!@$%^&*()-_=+|;:,.]*$"}),e.items.properties.server||(e.items.properties.server={type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9~!@$%^&*()-_=+|;:,.]*$"}),e.items.properties.port||(e.items.properties.port={type:"number",min:0,max:99999});for(let t=0;t<r.length;t++)e.items.expected.includes(r[t])?(r[t+1]&&(h[r[t]]=r[t+1]),t++):r[t]&&(a=a+"/"+r[t])}catch(t){return null}return c&&c[1]&&(h.query=c[1]),a&&(h.route=a),n&&(h.server=n),s&&(h.protocol=s),o&&(h.port=o),l&&l.length>1&&(h.type=l[l.length-1]),this.validate(h,t.length,e)?h:null};uuidShort=t=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",i="";for(;i.length<t;)i=e.charAt(Math.floor(Math.random()*e.length))+i;return i}}class e extends t{constructor(t,e,i){super();let s=this;this.retryAmount=5,this.timetoRequestPackage=3e3,this.netBeatInterval=2e3,this.networkID=e,this.url=t,this.origin=i,this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.id=0,this.readyState=3,this.rsOld=null,this.packageID=0,this.packageCb={},this.binaryBuffer=[],this.bufferLength=0,this.routineIntervalRef=null,this.netBeatIntervalRef=null,this.envNode="undefined"==typeof window,this.isServer=!1,this.CbObj=function(t,e,i){this.callback=t,this.time=e,this.retry=0,this.objBin=i},this.CbSub=function(t,e){this.route=t,this.socket=e},this.DataPackage=function(t,e,i,s,n,o=null){this.i=o,this.o=t,this.n=e,this.m=i,this.r=s,this.b=n,this.s=null},this.dataPackageSchema={type:"object",items:{properties:{i:{type:["string","null","undefined"],minLength:1,maxLength:22,pattern:"^[A-Za-z0-9_]*$"},o:{type:"string",minLength:1,maxLength:10,enum:["server","client","web","edge","proxy"]},n:{type:"string",minLength:1,maxLength:25,pattern:"^[A-Za-z0-9_]*$"},m:{type:"string",minLength:1,maxLength:10,enum:["beat","action","ping","get","post","put","patch","delete","new","unsub","sub","pub","message","io","res","keys"]},r:{type:"string",minLength:0,maxLength:2e3,pattern:"^[A-Za-z0-9_/?:&+.%=-]*$"},b:{type:["boolean","array","number","string","object"],minLength:0,maxLength:7e7},s:{type:["string","null","undefined"],minLength:0,maxLength:45,pattern:"^[A-Za-z0-9_]*$"},f:{type:["number","null","undefined"],min:1,max:99}},required:["i","o","n","m","r","b"]}},this.Response=function(t){this.send=(e,i)=>{if(t.i){if(i){if(!i.data)return void console.log("data object required {data: dataObject}")}else i=null;let n={obj:new s.DataPackage(s.origin,t.n,"res",t.r,{},t.i),bin:i};n.obj.b=e||204,s.send(n,null)}}},this.router=t=>{let e=0,i={obj:{},bin:{}};if("string"!=typeof t)if(this.bufferLength){if(this.binaryBuffer.push(t),this.binaryBuffer.length<=this.bufferLength)return;i.obj=this.binaryBuffer[0],i.bin.data=[];for(let t=1;t<this.binaryBuffer.length;t++)i.bin.data.push(this.binaryBuffer[t]);this.bufferLength=0,this.binaryBuffer=[],e=this.binaryBuffer.byteLength}else i=this.readBinary(t),e=t.byteLength,i.bin.data.byteLength||(i.bin.data=null);else if(i={obj:JSON.parse(t),bin:{data:null}},e=t.length,i.obj.f)return this.binaryBuffer=[],this.bufferLength=i.obj.f,void this.binaryBuffer.push(i.obj);"object"==typeof i.obj&&void 0!==i.obj.b&&(s.validate(i.obj,e,this.dataPackageSchema)?("ping"===i.obj.m&&s.networkID!==i.obj.n&&(this.emitInt("network",i.obj.n,s.networkID,i.obj),s.networkID=i.obj.n),i.obj.i&&"res"===i.obj.m?this.packageCb.hasOwnProperty(i.obj.i)&&(this.packageCb[i.obj.i].callback(i.obj.b,i.bin),delete this.packageCb[i.obj.i]):this.dataPackageSchema.items.properties.m.enum.includes(i.obj.m)&&this.routerCallback(i)):console.log("not allowed"))},this.routerCallback=t=>{t.obj.i?this.emitInt(t.obj.m,t.obj.r,t.obj.b,new this.Response(t.obj),t.bin):this.emitInt(t.obj.m,t.obj.r,t.obj.b,null,t.bin)},this.routineIntervalRef=setInterval(function(){this.readyState!==this.CLOSED&&this.readyState||this.isServer||this.connect(this.url,this.networkID,this.origin);for(let t in this.packageCb)this.timetoRequestPackage<Date.now()-this.packageCb[t].time&&this.packageCb.hasOwnProperty(t)&&(this.packageCb[t].retry++,this.retryAmount<this.packageCb[t].retry?delete this.packageCb[t]:(this.packageCb[t].time=Date.now(),this.resend(t)))}.bind(this),this.timetoRequestPackage),this.message=this.new=this.delete=this.patch=this.io=this.put=this.post=this.get=this.action=this.keys=this.beat=this.ping=(t,e,i)=>{};for(let t of this.dataPackageSchema.items.properties.m.enum)this[t]=(e,i,s,n)=>{if(n){if(!n.data)return void console.log("your binary must be a data object {data: binaryData}")}else n={data:null};let o={obj:new this.DataPackage(this.origin,this.networkID,t,e,i),bin:n};this.send(o,s)};this.createBinary=t=>{let e=null,i=this.enc.encode(JSON.stringify(t.obj));if(this.envNode){let s=Buffer.from(this.intToByte(i.byteLength));return e=Buffer.concat([s,i,t.bin.data]),e}{let e=t.bin.data?Uint8Array.from(t.bin.data):null,s=Uint8Array.from(this.intToByte(i.byteLength)),n=0;e&&(n=e.byteLength);let o=new Uint8Array(s.byteLength+i.byteLength+n);return o.set(s,0),o.set(i,s.byteLength),e&&o.set(e,s.byteLength+i.byteLength),o}},this.readBinary=t=>{let e=this.byteToInt(t.slice(0,4));return{obj:JSON.parse(this.dec.decode(t.slice(4,e+4))),bin:{data:t.slice(e+4,t.byteLength)}}},this.send=(t,e)=>{if(this.readyState===this.OPEN&&t.obj)if("function"==typeof e?(this.packageID<Number.MAX_SAFE_INTEGER?this.packageID++:this.packageID=0,t.obj.i=this.packageID+this.uuidShort(4),this.packageCb[t.obj.i]=new this.CbObj(e,Date.now(),t)):"res"!==t.obj.m&&(t.obj.i=null),t.bin&&t.bin.data)if(Array.isArray(t.bin.data)){t.obj.f=t.bin.data.length,this.socket.send(JSON.stringify(t.obj),{binary:!1});for(let e=0;e<t.bin.data.length;e++)this.socket.send(t.bin.data[e],{binary:!0})}else this.socket.send(this.createBinary(t),{binary:!0});else t.obj.f=null,this.socket.send(JSON.stringify(t.obj),{binary:!1})},this.resend=t=>{if(this.readyState===this.OPEN&&this.packageCb.hasOwnProperty(t)&&this.packageCb[t].objBin.bin)if(this.packageCb[t].objBin.bin.data)if(Array.isArray(this.packageCb[t].objBin.bin.data)){this.packageCb[t].objBin.obj.f=this.packageCb[t].objBin.bin.data.length,this.socket.send(JSON.stringify(this.packageCb[t].objBin.obj),{binary:!1});for(let e=0;e<this.packageCb[t].objBin.bin.data.length;e++)this.socket.send(this.packageCb[t].objBin.bin.data[e],{binary:!0})}else this.socket.send(this.createBinary(this.packageCb[t].objBin),{binary:!0});else this.socket.send(JSON.stringify(this.packageCb[t].objBin.obj),{binary:!1})},this.stateEmitter=(t,e)=>{this.readyState=e,this.emitInt(t,e),this.rsOld!==this.readyState&&(this.emitInt("status",this.readyState),this.rsOld=this.readyState)},this.attachEvents=()=>{this.envNode&&(this.socket.on("connected",(()=>{s.readyState=s.OPEN,s.stateEmitter("connected",s.OPEN)})),this.socket.on("connecting",(()=>{s.readyState=s.CONNECTING,s.stateEmitter("connecting",s.CONNECTING)}))),this.socket.onclose=()=>{s.readyState=s.CLOSED,s.stateEmitter("close",s.CLOSED),this.closer()},this.socket.onopen=()=>{s.readyState=s.OPEN,s.stateEmitter("open",s.OPEN),s.pingInt()},this.envNode?this.socket.onmessage=t=>{s.router(t.data)}:this.socket.onmessage=async t=>{"string"!=typeof t.data?s.router(new Uint8Array(await t.data.arrayBuffer())):s.router(t.data)},this.close=()=>(this.socket.close(),clearInterval(this.routineIntervalRef),clearInterval(this.netBeatIntervalRef),this.removeAllListeners(),this.sockets&&this.sockets.connected&&this.id&&delete this.sockets.connected[this.id],this.closer(),"closed"),this.closer=()=>{}},this.on("ping",(function(t,e,i){i.send("pong")})),this.pingInt=()=>{if(s.readyState===this.OPEN)try{this.ping("action/ping","ping",(function(t){"pong"===t?(s.emitInt("pong"),s.readyState=s.OPEN):s.readyState=s.CLOSED}))}catch(t){s.readyState=s.CLOSED,console.log(t)}else s.readyState=s.CLOSED},this.setNetworkId=t=>this.networkID=t}}class i extends t{constructor(){super();this.network=null,this.origin=null,this.socket=null,this.id=0,this.routeSchema={type:"object",items:{properties:{n:{type:"string",minLength:1,maxLength:25,pattern:"^[A-Za-z0-9_]*$"}},required:["n"],expected:["n"]}}}attachEvents(){this.emit=(t,e,i)=>{this.socket.io(t,e,null,i)},this.socket.on("connected",(()=>{this.connected=!0,this.emitInt("connected"),this.emitInt("connect")})),this.socket.on("connecting",(()=>{this.emitInt("connecting")})),this.socket.on("close",(()=>{this.emitInt("disconnect"),this.closer()})),this.socket.on("open",(()=>{this.connected=!0,this.emitInt("connect")})),this.socket.on("error",(t=>{this.emitInt("error",t)})),this.socket.on("io",((t,e,i,s)=>{this.emitInt(t,e,s)})),this.close=()=>this.socket.close(),this.closer=()=>{this.connected=!1,this.sockets&&this.sockets.connected&&this.id&&delete this.sockets.connected[this.id],this.emitInt("close")}}connect(t,e,i){if(this.socket&&(this.connected=!1,this.socket.close(),this.removeAllListeners()),this.origin="server",this.network="io",e&&(this.network=e),i&&(this.origin=i),"undefined"!=typeof window&&(this.origin="web"),!t&&"undefined"!=typeof window){let e={route:location.pathname,port:location.port,ip:location.hostname,protocol:location.protocol,ws:"ws://"};"https:"===e.protocol?e.ws="wss://":"http:"===e.protocol&&(e.ws="ws://"),t=e.ws+e.ip+":"+e.port+e.route}0===t.indexOf("http")&&(t=t.replace("http","ws"));let n=this.parseUrl(t,this.routeSchema);return n&&n.n&&!e&&(this.network=n.n),this.socket=new s(t,this.network,this.origin),this.attachEvents(),this}}class s extends e{constructor(t,e,i){super(t,e,i);let s=this;if(this.WebSocket=null,this.socket=null,"undefined"==typeof window)this.WebSocket=require("ws"),this.envNode=!0;else if("undefined"!=typeof WebSocket)this.WebSocket=WebSocket;else if("undefined"!=typeof MozWebSocket)this.WebSocket=MozWebSocket;else if("undefined"!=typeof global)this.WebSocket=global.WebSocket||global.MozWebSocket;else if("undefined"!=typeof window)this.WebSocket=window.WebSocket||window.MozWebSocket;else{if("undefined"==typeof self)return void console.log("websocket not available");this.WebSocket=self.WebSocket||self.MozWebSocket}this.netBeatIntervalRef=setInterval((()=>{s.readyState===s.OPEN&&s.pingInt()}),s.netBeatInterval),this.connect=(t,e,i)=>{e&&(s.networkID=e),i&&(s.origin=i),s.socket&&(s.readyState=s.CLOSED,s.socket.close()),s.socket=new s.WebSocket(t),s.socket.onerror=t=>{s.emitInt("error",t)},s.readyState=s.CONNECTING,s.attachEvents()},this.connect(this.url,this.networkID,this.origin)}static Server=class extends t{constructor(t,i){if(super(),this.origin=i||"server","undefined"!=typeof window)return;let s=this;this.socketID=1,this.webSockets={},console.log("ToolSocket Server Start");let n=require("ws");this.server=new n.Server(t),this.server.on("connection",((t,...i)=>{this.socketID>=Number.MAX_SAFE_INTEGER&&(this.socketID=1),this.socketID++,this.webSockets[this.socketID]=new class extends e{constructor(t){super(void 0,void 0,s.origin),this._socket=t._socket,this.socket=t,this.networkID||(this.networkID="toolbox"),this.envNode=!0,this.isServer=!0,this.readyState=this.OPEN,this.attachEvents()}}(t),this.webSockets[this.socketID].id=this.socketID+"",s.emitInt("connection",this.webSockets[this.socketID],...i)}))}};static Io=class extends i{constructor(t,e,i){super(t,e,i)}static Server=class extends t{constructor(t,e){if(super(),this.origin=e||"server","undefined"!=typeof window)return;console.log("IO is waiting for ToolSocket Server");let n=this;this.id=1,this.sockets={connected:{}},this.server=new s.Server(t),this.server.on("connection",((t,...e)=>{this.id>=Number.MAX_SAFE_INTEGER&&(this.id=1),this.id++,this.sockets.connected[this.id]=new class extends i{constructor(t){super(void 0,void 0,n.origin),this.socket=t,this.socket.networkID||(this.socket.networkID="io"),this.envNode=!0,this.isServer=!0,this.connected=!0,this.attachEvents()}}(t),this.sockets.connected[this.id].id=this.id+"",this.emitInt("connection",this.sockets.connected[this.id],...e)}))}}}}if("undefined"==typeof window)module.exports=s;else var n=new s.Io;