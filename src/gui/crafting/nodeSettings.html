<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="../../../css/index.css">
</head>
<body>
<div id="nodeSettingsContainer" class="settingsContainer" style="width: 568px; height: 320px; border: 2px solid black; background-color: rgb(100, 100, 100)">
    <div style="position: relative; height: 100px; width: 100px; margin-left: auto; margin-right: auto;">
        <img src="../../../svg/logicNode.svg" width="100px" height="100px" style="position: fixed; left: 0;"/>
        <img id="iconImage" src="../../../svg/menu/setting.svg" width="100px" height="100px" style="position: fixed; left: 0; border-radius: 30px;"/>
        <div style="width: 90px; height: 90px; border-radius: 30px; border: 5px solid cyan; position: fixed; left: 0;"></div>
    </div>
    <div id="currentLogicNameText" style="color: white; font-size: 12pt; font-weight: normal; margin-top: -5px;">LOGIC0</div>
    <div id="renameContainer" style="margin-bottom: 0;">
        <input id="newNameTextField" type="text" placeholder="" style="padding-top: 2px; padding-bottom: 2px; height: 35px; border-top-left-radius: 5px; border-bottom-left-radius: 5px; width: 250px; text-indent: 10px;">
        <button type="button" class="saveNewNameButton" style="width: 175px;">Rename Node</button>
    </div>

    <div id="newIconContainer" style="width: 435px; margin-left: auto; margin-right: auto;">
        <button class="iconTab" id="iconButtonNone" style="width: 33.3%; margin-right: -5px; border-top-left-radius: 5px; border-bottom-left-radius: 5px;">No Icon</button>
        <button class="iconTab iconTabSelected" id="iconButtonAuto" style="width: 33.3%; margin-left: -5px; margin-right: -5px;">Auto Icon</button>
        <button class="iconTab" id="iconButtonCustom" style="width: 33.3%; margin-left: -5px; border-top-right-radius: 5px; border-bottom-right-radius: 5px;">Custom Icon</button>
    </div>
    <input type="file" id="iconUploadButton" style="display: none; position: absolute; margin-top: 10px; left: 65px;">
    <div id="autoIconDescription" style="display: none; font-size: 12pt; position: absolute; left: 0; width: 100%; margin-top: -5px; font-weight: normal;">(uses icon of first block placed)</div>
    
</div>

<script>
    var possibleIconStates = ['None', 'Auto', 'Custom'];
    var iconButtonState = 'Auto';
    var iconButtons = {};
    
    var currentLogicNameText = document.querySelector('#currentLogicNameText');
    var newNameTextField = document.querySelector('#newNameTextField');
    var saveNewNameButton = document.querySelector('.saveNewNameButton');
    var iconUploadButton = document.querySelector('#iconUploadButton');
    var autoIconDescription = document.querySelector('#autoIconDescription');
    
    var currentLogicName = 'LOGIC0';
    
    initializeView();
    
    function initializeView() {
        newNameTextField.placeholder = currentLogicName;
        currentLogicNameText.innerHTML = currentLogicName;

        saveNewNameButton.onclick = function(e) {
            if (newNameTextField.value && newNameTextField.value !== '') {

                currentLogicName = newNameTextField.value;

                console.log("set new name of logic node to " + currentLogicName);

                // update label in node settings menu
                currentLogicNameText.innerHTML = currentLogicName;
                newNameTextField.placeholder = currentLogicName;

                // TODO: make this work inside an iframe by posting a message to the parent that triggers the following:
                /*
                globalStates.currentLogic.name = newNameTextField.value;
    
                // update node text label on AR view
                globalDOMCache["iframe" + globalStates.currentLogic.uuid].contentWindow.postMessage(
                    JSON.stringify( { renameNode: newNameTextField.value }) , "*");
    
                // update model and view for pocket menu
                var savedIndex = realityEditor.gui.memory.nodeMemories.getIndexOfLogic(globalStates.currentLogic);
                if (savedIndex > -1) {
                    realityEditor.gui.memory.nodeMemories.states.memories[savedIndex].name = newNameTextField.value;
                    document.querySelector('.nodeMemoryBar').children[savedIndex].firstChild.innerHTML = newNameTextField.value;
                }
                */

            }
        };

        possibleIconStates.forEach(function(state) {
            iconButtons[state] = document.getElementById('iconButton' + state);
            iconButtons[state].addEventListener('click', function(e) {
                updateIconButtonSelection(state);
            });
        });

        iconUploadButton.addEventListener('change', function(e) {
            console.log('image changed');
            uploadImageToServer();
        });

        updateIconButtonSelection(iconButtonState);
    }
    
    function updateIconButtonSelection(newSelection) {
        console.log('selected: ' + newSelection);
        iconButtonState = newSelection;
        possibleIconStates.forEach(function(state) {
            iconButtons[state].classList.remove('iconTabSelected');
        });
        iconButtons[newSelection].classList.add('iconTabSelected');

        iconUploadButton.style.display = 'none';
        autoIconDescription.style.display = 'none';

        switch (newSelection) {
            case 'None':
                useIconNone();
                break;
            case 'Auto':
                useIconAuto();
                break;
            case 'Custom':
                useIconCustom();
                break;
            default:
                break;
        } 
    }
    
    function useIconNone() {
        document.getElementById('iconImage').style.display = 'none';
    }
    
    function useIconAuto() {
        // var autoSrc = 'png/_test_icon_image.png';
        document.getElementById('iconImage').style.display = 'none'; // force re-render
        var autoSrc = '../../../svg/menu/setting.svg';
        document.getElementById('iconImage').src = autoSrc;// + '?' + new Date().getTime();
        setTimeout(function() {
            document.getElementById('iconImage').style.display = 'inline';
        }, 100);

        autoIconDescription.style.display = 'inline';
    }
    
    function useIconCustom() {
        // document.getElementById('iconImage').style.display = 'none'; // force re-render
        var customSrc = 'http://192.168.1.227:8080/logicNodeIcon/secondScreen/ZHg9f0rbute1.jpg';
        document.getElementById('iconImage').src = customSrc;// + '?' + new Date().getTime();
        setTimeout(function() {
            document.getElementById('iconImage').style.display = 'inline';
        }, 100);

        iconUploadButton.style.display = 'inline';
    }
    
    function uploadImageToServer() {
        // Update button text.
        // iconUploadButton.innerHTML = 'Uploading...';

        // Get the selected files from the input.
        var files = iconUploadButton.files;

        // Create a new FormData object.
        var formData = new FormData();

        // Loop through each of the selected files.
        for (var i = 0; i < files.length; i++) {
            var file = files[i];

            // Check the file type.
            if (!file.type.match('image.*')) {
                continue;
            }

            // Add the file to the request.
            formData.append('photos[]', file, file.name);
        }

        // Set up the request.
        var xhr = new XMLHttpRequest();
        
        var data = {
            ip: '192.168.1.227',
            httpPort: 8080,
            objectKey: 'secondScreenLQc0zt7ejv3x',
            frameKey: 'secondScreenLQc0zt7ejv3xgraphUI5ofroz12vjru',
            nodeKey: 'ZHg9f0rbute1'
        };
        var postUrl = 'http://' + data.ip + ':' + data.httpPort + '/object/' + data.objectKey + "/frame/" + data.frameKey + "/node/" + data.nodeKey + "/uploadIconImage/";

        // Open the connection.
        xhr.open('POST', postUrl, true);

        // Set up a handler for when the request finishes.
        xhr.onload = function () {
            if (xhr.status === 200) {
                // File(s) uploaded.
                // newIconSubmitButton.innerHTML = 'Upload';
                console.log('successful upload');
                setTimeout(function() {
                    var customSrc = 'http://192.168.1.227:8080/logicNodeIcon/secondScreen/ZHg9f0rbute1.jpg';
                    document.getElementById('iconImage').src = customSrc;// + '?' + new Date().getTime();
                    document.getElementById('iconImage').style.display = 'inline';
                }, 1000);

            } else {
                console.log('error uploading');
            }
        };
        
        // hide the existing image
        document.getElementById('iconImage').style.display = 'none';

        // Send the Data.
        xhr.send(formData);
    }

    // TODO: programmatically add this to the front of the network request, and remove from server-side
    // http://10.0.0.225:8080
    
</script>

</body>
</html>
